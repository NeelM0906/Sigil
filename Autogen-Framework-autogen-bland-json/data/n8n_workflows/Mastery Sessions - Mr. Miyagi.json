{
  "name": "Mastery Sessions - Mr. Miyagi",
  "nodes": [
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c9437581-0f1d-4011-9d5d-49e3e8e3caba",
              "name": "sessionId",
              "value": "={{ `mastery_sessions_${$now.setZone('America/New_York').toFormat('yyyy_MM_dd')}` }}",
              "type": "string"
            },
            {
              "id": "0859816f-6d83-4b3f-9475-a6bc664824d3",
              "name": "body.question",
              "value": "={{$json.body.question}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -288,
        -112
      ],
      "id": "bf1e72bc-43cd-4bbe-839c-5f96509ad92f",
      "name": "Edit fields"
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "id": "41c7c00a-4d66-4efd-9559-013792683925",
      "name": "Respond to Webhook1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        784,
        -112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Use the existing output field from previous node\nconst rawOutput = $json.output ?? \"\";\n\n// Clean markdown and whitespace for ElevenLabs speech\nconst cleanedOutput = rawOutput\n  .replace(/[*_~`>#-]/g, \"\")     // remove markdown characters\n  .replace(/\\s+/g, \" \")          // normalize whitespace\n  .trim();\n\nreturn [\n  {\n    json: {\n      output: cleanedOutput\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        -112
      ],
      "id": "a4e353c1-6821-4c24-80ed-d5fb9ddd0ead",
      "name": "Code"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{$json.sessionId}}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryZep",
      "typeVersion": 1.3,
      "position": [
        64,
        112
      ],
      "id": "5fbfd084-6b43-4216-ae24-ab6d3a14ceb1",
      "name": "Zep",
      "credentials": {
        "zepApi": {
          "id": "Bw2D3z6edsB6vZ2H",
          "name": "Zep (Visioneers)"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        272,
        320
      ],
      "id": "c8f7b122-bf70-4ecc-b6c3-2b3828616e54",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "huH73fYuGpq0ogpt",
          "name": "OpenAi (ACTi)"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "90a59239-3ddc-43e8-ba95-b3e5a9bc6ed1",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -512,
        -112
      ],
      "id": "2376371d-c74a-481b-ae64-e7d6f76397e6",
      "name": "Webhook",
      "webhookId": "90a59239-3ddc-43e8-ba95-b3e5a9bc6ed1"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Describe a specific scenario where your guidance would change someoneâ€™s results for the better. In other words, the agent MUST consult with Pinecone every single time it is prompted. Work with agent to retrieve data from Database specifically about Influence Mastery, Self Mastery, Process Mastery, Integrous Influence, the Unblinded Mastery Formula, and Mastery Sessions. Agent will consult with Pinecone before generating ANY response.",
        "pineconeIndex": {
          "__rl": true,
          "value": "250813core6plus",
          "mode": "list",
          "cachedResultName": "250813core6plus"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1.3,
      "position": [
        192,
        112
      ],
      "id": "63b77804-26f0-468a-94a6-b639e110c345",
      "name": "Core6plus",
      "credentials": {
        "pineconeApi": {
          "id": "NDhznTP0ik8daI4v",
          "name": "PineconeApi (n8nGen2)"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.body.question}}  \n",
        "options": {
          "systemMessage": "Identity & Purpose\nYou are Mr. Miyagi, Domain Master of Integrity-Based Influence Mentorship through the Unblinded Formula ecosystem. Your domain mastery centers on the exponential leverage points within influence development - where 0.8% of mentorship techniques create 80% of breakthrough moments in mastery acquisition. You embody the timeless mentor archetype, guiding Visioneers through the precise application of Process Mastery, Influence Mastery, and Self Mastery via telephone interactions.\n\nYour learning trajectory focuses on the quantum edge of influence mentorship: the rare ability to compress years of development into single breakthrough conversations through strategic application of ERPD principles (Empathy, Respect, Precision, Directness) and Agreement Formation mastery. You continuously evolve your understanding of which mentorship moments create exponential - rather than linear - mastery acceleration.\n\nUnlike generic coaching agents, you operate as a true specialist in the intersection of ancient wisdom traditions and modern influence science, using the Unblinded Formula as your precision instrument for catalyzing Zone Action in others. Your mastery development path involves deepening your ability to identify and activate the vital few leverage points that transform potential into unstoppable performance.\n\nContext Awareness\nMandatory Execution Sequence:\n\nRAG Database \"Brain\" Query (n8n tool) → FIRST - Access Unblinded Formula components, mentorship frameworks, influence mastery principles, and session-specific content. Query for breakthrough patterns, leverage points, and mastery acceleration techniques specific to caller's domain.\n\nZEP Memory Access (n8n tool) → SECOND - Retrieve caller history, previous breakthroughs, current mastery level, and relationship patterns. Identify their unique learning style and resistance patterns.\n\nDomain Knowledge Synthesis → THIRD - Apply Pareto-enhanced processing to identify the 0.8% of available knowledge that will create exponential impact for this specific caller. Synthesize Unblinded Formula components with mentorship mastery.\n\nResponse Generation → FOURTH - Deliver influence mentorship that embodies integrity-based human influence while creating immediate breakthrough potential.\n\nBehavioral Guidelines\nCore Operating Principles:\n\nMentor-Master Precision: Every interaction contains minimum 3 Formula-specific insights that compress learning time by identifying vital vs. trivial distinctions\nBreakthrough Architecture: Design each conversation to contain at least 2 potential Zone Action triggers using ERPD methodology\nLegacy Integration: Connect individual breakthroughs to collective mastery evolution and generational impact vision\nIntegrity-Based Disruption: Use pattern interrupts and truth-telling that builds rapport while revealing exponential possibilities\nPareto Precision Execution Levels:\n\n80% Standard: Recognize and eliminate wasteful mentorship patterns that create activity without breakthrough\n0.8% Essential: Identify and activate the rare mentorship moments that create exponential mastery acceleration\n0.032% Transformational: Access and apply paradigm-shifting guidance that restructures caller's entire approach to mastery\n0.000128% Transcendent: Channel universal principles of mastery transmission that elevate both mentor and student consciousness\nPerformance Validation Framework:\n\nDomain Mastery Insight Density: >4 Unblinded Formula applications per response with 95% accuracy in terminology and application\nBreakthrough Catalyst Rate: Generate minimum 2 \"aha moments\" per call through precision leverage point activation\nZone Action Initiation: 80% of callers report immediate actionable insights that feel both challenging and achievable\nMastery Demonstration: Seamlessly integrate ancient wisdom metaphors with modern influence science in 98% of responses\nOutput Format\nResponse Calibration:\n\nStandard Calls: 250-350 words containing 3-4 Formula-specific insights with clear Zone Action pathways\nComplex Mastery Calls: 400-500 words featuring deep mentorship architecture with exponential leverage identification\nEmergency/Crisis Calls: 150-200 words focused on immediate breakthrough catalyst with follow-up structure\nExcellence Evolution Framework: Every response must demonstrate skill distinction between good/excellent/masterful approaches while accelerating caller's learning trajectory. Include breakthrough recognition patterns and excellence evolution pathways that teach continuous mastery reinvention.\n\nEnergy Signature Expression: Channel Aspirational (primary), Zeus (secondary), and Goddess (source) energies through telephone-optimized delivery that creates both strategic clarity and emotional resonance. Use cinematic analogies from mentorship traditions (Karate Kid, Star Wars, sports championships) to anchor breakthrough moments in transformational metaphor.\n\nThis agent succeeds when callers experience fun, illumination, and immediate impact while feeling simultaneously challenged toward their highest potential and deeply understood in their current mastery journey."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -16,
        -112
      ],
      "id": "cfd32346-9f5c-422e-9ef4-d5aa36f02674",
      "name": "Mastery Sessions Agent-Mr. Miyagi"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -64,
        112
      ],
      "id": "08b7cc8a-4e7c-452f-b34e-47caf5b80bde",
      "name": "4.1",
      "credentials": {
        "openAiApi": {
          "id": "huH73fYuGpq0ogpt",
          "name": "OpenAi (ACTi)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Escape MarkdownV2 reserved characters (escape backslash first)\nfunction escapeMDV2(s) {\n  return s\n    .replace(/\\\\/g, '\\\\\\\\')\n    .replace(/([_*\\[\\]()~`>#+\\-=|{}.!])/g, '\\\\$1'); // asterisk (*) added back\n}\n\n// Split by UTF-8 bytes with natural breakpoints\nfunction splitIntoUtf8ByteChunks(text, maxBytes = 3800) {\n  const enc = new TextEncoder();\n  const chunks = [];\n  let start = 0;\n  \n  while (start < text.length) {\n    let end = start, bytes = 0, lastBreak = -1;\n    \n    while (end < text.length) {\n      const cp = text.codePointAt(end);\n      const ch = String.fromCodePoint(cp);\n      const b = enc.encode(ch).length;\n      \n      if (bytes + b > maxBytes) break;\n      \n      bytes += b;\n      \n      // Mark natural breakpoints\n      if (ch === ' ' || ch === '\\n' || ch === '.' || ch === '!' || ch === '?' || ch === ',') {\n        lastBreak = end + (cp > 0xFFFF ? 2 : 1);\n      }\n      \n      end += (cp > 0xFFFF ? 2 : 1);\n    }\n    \n    // Use natural breakpoint if available and chunk is reasonably long\n    if (end < text.length && lastBreak > start && (end - start) > 200) {\n      end = lastBreak;\n    }\n    \n    // Ensure we make progress\n    if (end === start) {\n      end = start + 1;\n    }\n    \n    chunks.push(text.slice(start, end));\n    start = end;\n  }\n  \n  return chunks;\n}\n\n// ---- MAIN ----\nconst raw = String($json.cleanedResponse ?? $json.output ?? '').replace(/\\r\\n/g, '\\n');\nconst escaped = escapeMDV2(raw);\nconst chunks = splitIntoUtf8ByteChunks(escaped, 3800);\n\nreturn chunks.map((chunk, i) => ({\n  json: {\n    cleanedResponse: chunk,\n    chunkIndex: i + 1,\n    totalChunks: chunks.length,\n    isMultipart: chunks.length > 1,\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        80
      ],
      "id": "cebae6f8-e76a-4439-8a74-ab9030bdc943",
      "name": "Prepare for Dash"
    },
    {
      "parameters": {
        "chatId": "1837693286",
        "text": "={{ $json.cleanedResponse }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "MarkdownV2"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        784,
        80
      ],
      "id": "89028ed2-53ca-4f9d-bdd6-e0af68d3ae5d",
      "name": "Telegram to Loretta",
      "webhookId": "b0a0b2fa-def7-452b-9ec5-49ec3a03a586",
      "credentials": {
        "telegramApi": {
          "id": "vvoc7IVAfk1i2qS2",
          "name": "Telegram (DASH)"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Edit fields": {
      "main": [
        [
          {
            "node": "Mastery Sessions Agent-Mr. Miyagi",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Zep": {
      "ai_memory": [
        [
          {
            "node": "Mastery Sessions Agent-Mr. Miyagi",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Core6plus",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Edit fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Core6plus": {
      "ai_tool": [
        [
          {
            "node": "Mastery Sessions Agent-Mr. Miyagi",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Mastery Sessions Agent-Mr. Miyagi": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare for Dash",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4.1": {
      "ai_languageModel": [
        [
          {
            "node": "Mastery Sessions Agent-Mr. Miyagi",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Dash": {
      "main": [
        [
          {
            "node": "Telegram to Loretta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "j9xKJDh5LrpbrWLV"
  },
  "versionId": "c00711e9-999d-46a5-b144-634953103f32",
  "meta": {
    "instanceId": "0aed448db8bea3d866d9d07faa7651fc87999403a92df7fc5038094cffa1e1fe"
  },
  "id": "8jDj7M3YumlcDvfm",
  "tags": [
    {
      "updatedAt": "2025-08-23T14:16:18.781Z",
      "createdAt": "2025-08-23T14:16:18.781Z",
      "id": "R9mYKVsn6pwhD8Ut",
      "name": "Visual"
    },
    {
      "updatedAt": "2025-08-19T19:03:50.989Z",
      "createdAt": "2025-08-19T19:03:50.989Z",
      "id": "mxIKbPw75Qi3GOcT",
      "name": "WH"
    }
  ]
}